<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Etiquetas</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body class="p-4">
    <div class="container">
      <h2>Gestión de Etiquetas</h2>
      <p>Bienvenido, <span id="userInfo"></span></p>

      <button
        class="btn btn-primary mb-3"
        data-bs-toggle="modal"
        data-bs-target="#tagModal"
        onclick="openCreateModal()"
      >
        <i class="bi bi-plus-circle"></i> Nueva Etiqueta
      </button>

      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>Nombre</th>
            <th style="width: 150px">Acciones</th>
          </tr>
        </thead>
        <tbody id="tagTableBody"></tbody>
      </table>
    </div>

    <!-- Modal para Crear/Editar Etiqueta -->
    <div class="modal fade" id="tagModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" onsubmit="submitTagForm(event)">
          <div class="modal-header">
            <h5 class="modal-title" id="tagModalLabel">Nueva Etiqueta</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="tagId" />
            <div class="mb-3">
              <label for="tagName" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="tagName" required />
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Guardar</button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Toasts -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
      <div id="successToast" class="toast text-bg-success" role="alert">
        <div class="d-flex">
          <div class="toast-body">Operación exitosa.</div>
          <button
            type="button"
            class="btn-close me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>

      <div id="errorToast" class="toast text-bg-danger" role="alert">
        <div class="d-flex">
          <div class="toast-body">Ha ocurrido un error.</div>
          <button
            type="button"
            class="btn-close me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../utils/axiosInstance.js"></script>
    <script src="../services/authService.js"></script>
    <script src="../services/tagService.js"></script>
    <script>
      let tagModal;

      document.addEventListener("DOMContentLoaded", async () => {
        tagModal = new bootstrap.Modal(document.getElementById("tagModal"));

        try {
          const authData = await authStatus();
          document.getElementById("userInfo").textContent =
            authData.data.user.first_name + " " + authData.data.user.last_name;
          loadTags();
        } catch (error) {
          showToast("error", error);
          setTimeout(() => {
            window.location.href = "../auth/sign-in.html";
          }, 2000);
        }
      });

      const showToast = (type, message) => {
        const toastId = type === "success" ? "successToast" : "errorToast";
        const toastElement = document.getElementById(toastId);
        toastElement.querySelector(".toast-body").textContent = message;
        new bootstrap.Toast(toastElement).show();
      };

      const loadTags = async () => {
        try {
          const res = await getTags();
          const tbody = document.getElementById("tagTableBody");
          tbody.innerHTML = "";
          res.data.tags.forEach((tag) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${tag.title}</td>
              <td>
                <button class="btn btn-warning btn-sm me-1" onclick='openEditModal("${tag._id}", "${tag.title}")'>
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick='deleteTagHandler("${tag._id}")'>
                  <i class="bi bi-trash"></i>
                </button>
              </td>`;
            tbody.appendChild(row);
          });
        } catch (error) {
          showToast("error", error);
        }
      };

      const openCreateModal = () => {
        document.getElementById("tagId").value = "";
        document.getElementById("tagName").value = "";
        document.getElementById("tagModalLabel").textContent = "Nueva Etiqueta";
      };

      const openEditModal = (id, name) => {
        document.getElementById("tagId").value = id;
        document.getElementById("tagName").value = name;
        document.getElementById("tagModalLabel").textContent =
          "Editar Etiqueta";
        tagModal.show();
      };

      const submitTagForm = async (e) => {
        e.preventDefault();
        const tagId = document.getElementById("tagId").value;
        const tagName = document.getElementById("tagName").value;

        try {
          if (tagId) {
            await updateTag(tagId, { title: tagName });
            showToast("success", "Etiqueta actualizada.");
          } else {
            await createTag({ title: tagName });
            showToast("success", "Etiqueta creada.");
          }
          tagModal.hide();
          loadTags();
        } catch (error) {
          showToast("error", error);
        }
      };

      const deleteTagHandler = async (tagId) => {
        if (confirm("¿Estás seguro de eliminar esta etiqueta?")) {
          try {
            await deleteTag(tagId);
            showToast("success", "Etiqueta eliminada.");
            loadTags();
          } catch (error) {
            showToast("error", error);
          }
        }
      };
    </script>
  </body>
</html>
